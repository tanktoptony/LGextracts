{% extends "base.html" %}
{% block page_title %}
  <h2 class="text-center mt-4">ðŸŽ¡ Spin & Win</h2>
{% endblock page_title %}

{% block page_content %}
<div class="container my-5 text-center">
  <p class="mb-3">Scan the QR code in-store or tap the button to spin. One spin per visit.</p>

  <canvas id="wheel" width="360" height="360" style="max-width: 360px; width: 100%;"></canvas>
  <div class="mt-3">
    <button id="spinBtn" class="btn btn-primary">Spin the Wheel</button>
  </div>

  <p class="text-muted mt-3" style="font-size: .9rem;">Prizes: Hat Â· Shirt Â· Bong Â· Hoody</p>

  <hr class="my-4" />
</div>

<form method="post" class="lottery-form">
  {% csrf_token %}
  <input type="text" name="name" placeholder="Your Name" required>
  <input type="email" name="email" placeholder="Your Email" required>
  <input type="text" name="prize" placeholder="Prize" required>
  <button type="submit" class="btn btn-primary">Submit</button>
</form>


<script>
(function () {
  const prizes = ["Hat","Shirt","Bong","Hoody"];
  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const size = canvas.width;
  const radius = size / 2;
  const slice = (2 * Math.PI) / prizes.length;
  const colors = ["#eee","#ddd","#eee","#ddd"]; // alternating

  function drawWheel(rotation=0) {
    ctx.clearRect(0,0,size,size);
    ctx.save();
    ctx.translate(radius, radius);
    ctx.rotate(rotation);
    for (let i = 0; i < prizes.length; i++) {
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.fillStyle = colors[i % colors.length];
      ctx.arc(0,0,radius, i*slice, (i+1)*slice);
      ctx.fill();
      // Labels
      ctx.save();
      ctx.rotate(i*slice + slice/2);
      ctx.textAlign = "right";
      ctx.fillStyle = "#222";
      ctx.font = "bold 16px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText(prizes[i], radius - 10, 5);
      ctx.restore();
    }
    // center hub
    ctx.beginPath();
    ctx.arc(0,0,28,0,2*Math.PI);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#888";
    ctx.stroke();

    ctx.restore();

    // pointer
    ctx.beginPath();
    ctx.moveTo(radius, radius - 8);
    ctx.lineTo(size - 8, radius);
    ctx.lineTo(radius, radius + 8);
    ctx.closePath();
    ctx.fillStyle = "#e5533d";
    ctx.fill();
  }
  drawWheel(0);

  function spin() {
    const rotations = 5 + Math.random() * 3;   // 5â€“8 turns
    const targetIndex = Math.floor(Math.random() * prizes.length);
    const stopAngle = (Math.PI/2) - (targetIndex * slice + slice/2); // align pointer to target
    const finalRotation = rotations * 2*Math.PI + stopAngle;

    const duration = 4000;
    const start = performance.now();

    function animate(t) {
      const elapsed = t - start;
      const progress = Math.min(elapsed / duration, 1);
      // easeOutCubic
      const eased = 1 - Math.pow(1 - progress, 3);
      drawWheel(eased * finalRotation);
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        // redirect to claim form with selected prize
        const prize = prizes[targetIndex];
        const url = "{% url 'promo_claim' %}" + `?prize=${encodeURIComponent(prize)}`;
        window.location.href = url;
      }
    }
    requestAnimationFrame(animate);
  }

  document.getElementById("spinBtn").addEventListener("click", spin);
})();
</script>
{% endblock page_content %}
